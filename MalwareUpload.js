const express = require('express');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
const app = express();

const upload = multer({ dest: 'uploads/' });

// Fake upload endpoint
app.post('/upload', upload.single('file'), (req, res) => {
  if (!req.file) return res.status(400).send('No file uploaded.');

  const originalName = req.file.originalname;
  const filePath = req.file.path;
  const mimeType = req.file.mimetype;
  const suspicious = /\.exe$|\.bat$|\.sh$|\.js$|\.php$|\.py$|\.jar$|\.ps1$/i.test(originalName);

  // Calculate file hash
  const fileBuffer = fs.readFileSync(filePath);
  const fileHash = crypto.createHash('sha256').update(fileBuffer).digest('hex');

  logUploadAttempt(req, originalName, mimeType, fileHash, suspicious);

  res.status(200).send(`File uploaded: ${originalName}<br>${suspicious ? '<b>Suspicious file type detected</b>' : 'No threat detected'}`);
});

function logUploadAttempt(req, fileName, mimeType, fileHash, suspicious) {
  const log = {
    ip: req.ip,
    time: new Date().toISOString(),
    userAgent: req.headers['user-agent'],
    fileName,
    mimeType,
    hash: fileHash,
    suspicion: suspicious
  };
  fs.appendFileSync(
    path.join(__dirname, 'honeypot.log'),
    JSON.stringify(log) + '\n'
  );
}

app.listen(8088, () => {
  console.log('Malware Upload honeypot running on port 8088');
});
